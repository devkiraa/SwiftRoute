<%# Set the page title, using the value passed from the route or a default %>
<% locals.pageTitle = typeof title !== 'undefined' ? title : 'Order Details' %>
<%# Check if hasAccess variable was passed (needed for Edit button logic) %>
<% const canEditOrder = typeof hasAccess !== 'undefined' && hasAccess; %>

<header class="py-3 px-6 border-b border-gray-200 bg-white shadow-sm flex-shrink-0">
    <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800"><%= locals.pageTitle %></h2>
        <a href="/orders" class="inline-block px-3 py-1.5 border border-gray-300 text-xs font-medium text-gray-700 rounded-md hover:bg-gray-50">
            Back to Orders
        </a>
    </div>
</header>

<section class="p-6 flex-1 overflow-y-auto">
     <%# Display Flash Messages or Query Params for errors/success %>
     <%# Note: Requires middleware like 'connect-flash' or parsing req.query %>
     <% if (typeof error !== 'undefined' && error) { %>
        <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-4xl mx-auto" role="alert">
            <strong class="font-bold">Error!</strong> <span class="block sm:inline"><%= error %></span>
        </div>
     <% } %>
     <% if (typeof success_msg !== 'undefined' && success_msg) { %>
        <div class="mb-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative max-w-4xl mx-auto" role="alert">
            <strong class="font-bold">Success!</strong> <span class="block sm:inline"><%= success_msg %></span>
        </div>
     <% } %>

     <%# Check if the main order object exists %>
     <% if (typeof order !== 'undefined' && order) { %>
        <div class="bg-white p-6 border rounded-lg shadow-sm max-w-4xl mx-auto">

            <%# --- Order Summary Row --- %>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 pb-6 border-b">
                <div>
                    <h3 class="text-xs font-medium uppercase text-gray-500 mb-1">Order ID</h3>
                    <p class="text-sm text-gray-800 font-mono"><%= order._id %></p>
                </div>
                <div>
                    <h3 class="text-xs font-medium uppercase text-gray-500 mb-1">Date Placed</h3>
                    <p class="text-sm text-gray-800"><%= new Date(order.placedDate).toLocaleString() %></p>
                </div>
                <div>
                    <h3 class="text-xs font-medium uppercase text-gray-500 mb-1">Status</h3>
                     <%# Calculate status class %>
                     <% let statusClass = 'bg-gray-100 text-gray-800'; switch (order.orderStatus) { case 'pending': statusClass = 'bg-yellow-100 text-yellow-800'; break; case 'confirmed': statusClass = 'bg-blue-100 text-blue-800'; break; case 'shipped': statusClass = 'bg-purple-100 text-purple-800'; break; case 'delivered': statusClass = 'bg-green-100 text-green-800'; break; case 'cancelled': statusClass = 'bg-red-100 text-red-800'; break; } %>
                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full capitalize <%= statusClass %>">
                       <%= order.orderStatus %>
                    </span>
                </div>
            </div>

            <%# --- Details Row (Recipient/Customer, Store, Shipping) --- %>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 pb-6 border-b">
                 <div>
                     <h3 class="text-base font-semibold text-gray-700 mb-2">Recipient Details</h3>
                     <p class="text-sm text-gray-600"><strong>Name:</strong> <%= order.customerName || 'N/A' %></p>
                     <p class="text-sm text-gray-600"><strong>Phone:</strong> <%= order.customerPhone || 'N/A' %></p>
                     <%# Show linked user if available %>
                     <% if(order.customerId) { %>
                         <p class="text-sm text-gray-600 mt-1 pt-1 border-t">
                             <strong>Linked User:</strong><br> <%= order.customerId.username %> (<%= order.customerId.email %>)
                         </p>
                     <% } %>
                 </div>
                 <div>
                     <h3 class="text-base font-semibold text-gray-700 mb-2">Store Details</h3>
                     <p class="text-sm text-gray-600"><strong>Name:</strong> <%= order.storeId?.storeName || 'N/A' %></p>
                     <p class="text-sm text-gray-600"><strong>Phone:</strong> <%= order.storeId?.phone || 'N/A' %></p>
                 </div>
                 <div>
                     <h3 class="text-base font-semibold text-gray-700 mb-2">Shipping Address</h3>
                     <p class="text-sm text-gray-600"><%= order.shippingAddress %></p> <%# Assumes this is the Store's address %>
                 </div>
            </div>

             <%# --- Order Items Table --- %>
             <div>
                <h3 class="text-base font-semibold text-gray-700 mb-3">Order Items</h3>
                <div class="overflow-x-auto border rounded-md">
                     <table class="min-w-full divide-y divide-gray-200">
                         <thead class="bg-gray-50"> <tr> <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th> <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th> <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th> <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th> <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th> </tr> </thead>
                         <tbody class="bg-white divide-y divide-gray-200 text-sm">
                              <% if(order.orderItems && order.orderItems.length > 0) { %>
                                 <% order.orderItems.forEach(item => { %>
                                    <tr>
                                        <td class="px-4 py-2 whitespace-nowrap"><%= item.itemId?.name || '(Item Deleted)' %></td>
                                        <td class="px-4 py-2 whitespace-nowrap font-mono text-xs"><%= item.itemId?.sku || 'N/A' %></td>
                                        <td class="px-4 py-2 text-right"><%= item.quantity %></td>
                                        <td class="px-4 py-2 text-right">₹<%= item.priceAtOrder.toFixed(2) %></td> <%# Added currency symbol %>
                                        <td class="px-4 py-2 text-right font-medium">₹<%= (item.quantity * item.priceAtOrder).toFixed(2) %></td> <%# Added currency symbol %>
                                    </tr>
                                 <% }) %>
                             <% } else { %>
                                 <tr><td colspan="5" class="text-center py-4 text-gray-500">No items found in this order.</td></tr>
                             <% } %>
                         </tbody>
                         <% if(order.orderItems && order.orderItems.length > 0) { %>
                         <tfoot class="bg-gray-50">
                             <tr>
                                 <td colspan="4" class="px-4 py-2 text-right text-sm font-medium text-gray-700">Total Amount:</td>
                                 <td class="px-4 py-2 text-right text-sm font-bold text-gray-900">₹<%= order.totalAmount.toFixed(2) %></td> <%# Added currency symbol %>
                             </tr>
                         </tfoot>
                         <% } %>
                     </table>
                </div>
             </div>

             <% if(typeof allowedActions === 'object' && allowedActions && (allowedActions.canUpdateStatus || allowedActions.canAssignDelivery || true)) { // Added true for invoice always %>
                <div class="mt-6 pt-4 border-t">
                    <h3 class="text-base font-semibold text-gray-700 mb-3">Actions</h3>
                    <div class="space-y-4 md:space-y-0 md:flex md:items-start md:flex-wrap md:gap-4">
    
                        <% if (['pending', 'confirmed'].includes(order.orderStatus) && locals.loggedInUser && ['admin', 'warehouse_owner', 'store_owner', 'employee'].includes(loggedInUser.role) && canEditOrder) { %>
                            <div class="flex-shrink-0 mb-2 md:mb-0">
                                <a href="/orders/<%= order._id %>/edit" class="inline-block px-3 py-2 border border-blue-500 text-blue-600 text-sm font-medium rounded-md hover:bg-blue-50">Edit Order Items</a>
                            </div>
                        <% } %>
    
                        <% if (allowedActions.canUpdateStatus) { %>
                            <%
                                const currentStatus = order.orderStatus;
                                let nextOptions = [];
                                if (currentStatus === 'pending') { nextOptions = [['confirmed','Confirm'], ['cancelled','Cancel']]; }
                                else if (currentStatus === 'confirmed') { nextOptions = [['shipped','Ship'], ['cancelled','Cancel']]; }
                                else if (currentStatus === 'shipped') { nextOptions = [['delivered','Deliver'], ['cancelled','Cancel']]; } // Allow cancelling shipped?
                            %>
                            <% if (nextOptions.length > 0) { %>
                                <form action="/orders/<%= order._id %>/status?_method=PUT" method="POST" class="flex items-center space-x-2 flex-shrink-0 mb-2 md:mb-0">
                                    <label for="newStatus" class="text-sm font-medium text-gray-700 whitespace-nowrap">Status:</label>
                                    <select name="newStatus" id="newStatus" required class="block w-full max-w-[150px] px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="" disabled selected>Change to...</option>
                                        <% nextOptions.forEach(opt => { %>
                                            <option value="<%= opt[0] %>"><%= opt[1] %></option>
                                        <% }); %>
                                    </select>
                                    <button type="submit" class="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded-md hover:bg-green-700">Update</button>
                                </form>
                            <% } else { %>
                                <p class="text-sm text-gray-500 italic flex-shrink-0 mb-2 md:mb-0">(No status actions available)</p>
                            <% } %>
                        <% } %>
    
                        <% if (allowedActions.canAssignDelivery) { %>
                             <form action="/orders/<%= order._id %>/assign-driver" method="POST" class="flex-grow mb-2 md:mb-0">
                                <label for="driverId" class="block text-sm font-medium text-gray-700 mb-1"> Assign Delivery Partner </label>
                                <% if (order.assignedDeliveryPartnerId) { %>
                                    <p class="text-sm text-gray-600 mb-2"> Assigned: <span class="font-medium"><%= order.assignedDeliveryPartnerId.username %></span> (<a href="#" onclick="event.preventDefault(); document.getElementById('unassign-form-<%= order._id %>').submit();" class="text-red-600 hover:underline text-xs">Unassign</a>) </p>
                                <% } else { %> <p class="text-sm text-gray-500 italic mb-2">Not assigned</p> <% } %>
                                <div class="flex items-center space-x-2">
                                    <select name="driverId" id="driverId" class="block w-full max-w-xs px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="">-- Select Driver --</option> <%# Empty option for unassigning %>
                                        <% if (typeof availableDrivers !== 'undefined' && availableDrivers.length > 0) { %>
                                            <% availableDrivers.forEach(driver => { %>
                                                <option value="<%= driver._id %>" <%= order.assignedDeliveryPartnerId?._id.toString() === driver._id.toString() ? 'selected' : '' %>>
                                                    <%= driver.username %>
                                                </option>
                                            <% }); %>
                                        <% } else if (!order.assignedDeliveryPartnerId) { %>
                                            <option value="" disabled>No drivers available</option>
                                        <% } %>
                                    </select>
                                    <button type="submit" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700" <%# Disable if no drivers and none assigned %>>
                                        <%= order.assignedDeliveryPartnerId ? 'Re-assign' : 'Assign' %>
                                    </button>
                                </div>
                            </form>
                            <% if (order.assignedDeliveryPartnerId) { %>
                               <form id="unassign-form-<%= order._id %>" action="/orders/<%= order._id %>/assign-driver" method="POST" class="hidden">
                                   <input type="hidden" name="driverId" value="">
                               </form>
                            <% } %>
                        <% } %>
    
                        <% if (['admin', 'warehouse_owner', 'store_owner'].includes(locals.loggedInUser.role)) { %>
                            <div class="flex-shrink-0 mb-2 md:mb-0">
                                <a href="/orders/<%= order._id %>/invoice/pdf"
                                   target="_blank"
                                   class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                      <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                                    </svg>
                                    Download Invoice
                                </a>
                            </div>
                         <% } %>
    
                    </div>
                </div>
            <% } %>
        </div>
        <% } else { %>
            <p class="text-center text-gray-500">Order data could not be loaded.</p>
        <% } %>
    </section>