<% locals.pageTitle = typeof title !== 'undefined' ? title : 'Edit Order' %>
<% const isEditing = true; %> <%# Flag for potential shared partials later %>

<header class="py-3 px-6 border-b border-gray-200 bg-white shadow-sm flex-shrink-0">
    <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800"><%= locals.pageTitle %></h2>
        <a href="/orders/<%= order._id %>" class="inline-block px-3 py-1.5 border border-gray-300 text-xs font-medium text-gray-700 rounded-md hover:bg-gray-50">
            Cancel Edit
        </a>
    </div>
</header>

<section class="p-6 flex-1 overflow-y-auto">
    <div class="max-w-4xl mx-auto">

        <% if (typeof error !== 'undefined' && error) { %>
        <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline"><%= error %></span>
        </div>
        <% } %>

        <% if (typeof order === 'undefined' || !order) { %>
             <p class="text-center text-red-600">Order data not found.</p>
        <% } else { %>
            <%# Use method-override to send PUT request %>
            <form action="/orders/<%= order._id %>?_method=PUT" method="POST" id="order-edit-form" class="bg-white p-6 border rounded-lg shadow-sm space-y-6">

                <%# --- Store and Warehouse Info (Read-only) --- %>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Store</label>
                        <p class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-100 sm:text-sm"><%= order.storeId?.storeName || 'N/A' %></p>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fulfilling Warehouse</label>
                        <p class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-100 sm:text-sm"><%= order.warehouseId?.name || 'N/A' %></p>
                        <input type="hidden" name="storeId" value="<%= order.storeId?._id %>"> <%# Still need IDs for context %>
                        <input type="hidden" name="warehouseId" value="<%= order.warehouseId?._id %>">
                    </div>
                </div>

                <%# --- Customer Details (Editable) --- %>
                <fieldset class="border p-3 rounded">
                    <legend class="text-sm font-medium px-1">Recipient/Customer Info (at Store)</legend>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                         <div>
                            <label for="customerName" class="block text-xs font-medium text-gray-700 mb-1">Recipient Name <span class="text-red-500">*</span></label>
                            <input type="text" id="customerName" name="customerName" value="<%= order.customerName || '' %>" required class="block w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                         <div>
                            <label for="customerPhone" class="block text-xs font-medium text-gray-700 mb-1">Recipient Phone</label>
                            <input type="tel" id="customerPhone" name="customerPhone" value="<%= order.customerPhone || '' %>" class="block w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                     </div>
                </fieldset>

                <%# --- Order Items (Editable) --- %>
                <fieldset class="border p-3 rounded">
                    <legend class="text-sm font-medium px-1">Order Items</legend>
                     <div id="order-items-container" class="space-y-3 mt-2">
                        <%# Loop through existing items %>
                        <% order.orderItems.forEach((orderedItem, index) => { %>
                            <% const itemDetails = orderedItem.itemId; %> <%# Populated item details %>
                             <div class="flex items-end space-x-2 order-item-row">
                                <div class="flex-grow">
                                     <label class="block text-xs font-medium text-gray-700 mb-1">Item <span class="text-red-500">*</span></label>
                                     <select name="itemIds[]" required class="item-select mt-1 block w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">-- Select Item --</option>
                                         <% if (typeof items !== 'undefined') { items.forEach(item => { %>
                                             <option value="<%= item._id %>"
                                                 data-price="<%= item.price %>"
                                                 data-sku="<%= item.sku %>"
                                                 data-stock="<%= item.quantity %>"
                                                 data-warehouse="<%= item.warehouseId?.name || 'N/A' %>"
                                                 <%= (itemDetails && item._id.toString() === itemDetails._id.toString()) ? 'selected' : '' %>>
                                                <%= item.name %> (<%= item.sku %>) - <%= item.warehouseId?.name %> (Stock: <%= item.quantity %>)
                                             </option>
                                         <% }) } %>
                                     </select>
                                 </div>
                                 <div class="w-24">
                                     <label class="block text-xs font-medium text-gray-700 mb-1">Quantity <span class="text-red-500">*</span></label>
                                     <input type="number" name="quantities[]" value="<%= orderedItem.quantity %>" required min="1" class="item-quantity mt-1 block w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                 </div>
                                 <button type="button" class="remove-item-btn px-2 py-1.5 border border-red-300 text-red-600 hover:bg-red-50 rounded-md text-xs" onclick="removeItemRow(this)">Remove</button>
                             </div>
                        <% }) %>
                        <%# If order has no items initially, show one empty row %>
                        <% if (!order.orderItems || order.orderItems.length === 0) { %>
                            <div class="flex items-end space-x-2 order-item-row">
                                 <div class="flex-grow"> <label class="block text-xs ...">Item <span class="text-red-500">*</span></label> <select name="itemIds[]" required class="item-select mt-1 ..."> <option value="">-- Select Item --</option> <% if (typeof items !== 'undefined') { items.forEach(item => { %> <option value="<%= item._id %>" data-price="..." data-sku="..." data-stock="..." data-warehouse="...">...</option> <% }) } %> </select> </div>
                                 <div class="w-24"> <label class="block text-xs ...">Quantity <span class="text-red-500">*</span></label> <input type="number" name="quantities[]" value="1" required min="1" class="item-quantity mt-1 ..."> </div>
                                 <button type="button" class="remove-item-btn px-2 ..." onclick="removeItemRow(this)">Remove</button>
                             </div>
                        <% } %>
                     </div>
                     <button type="button" id="add-item-btn" class="mt-3 px-3 py-1.5 border border-dashed border-gray-400 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-50">
                         + Add Another Item
                    </button>
                 </fieldset>

                <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                     <a href="/orders/<%= order._id %>" class="px-4 py-2 border border-gray-300 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-50 mr-3">Cancel</a>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Update Order
                    </button>
                </div>
            </form>
        <% } %> <%# End of if(order) %>
    </div>
</section>

<%# --- Client-side JS for dynamic items --- %>
<script>
    // Reuse the same JS from orders/form.ejs for adding/removing items
    const availableItems = <%- JSON.stringify(items || []) %>;
    function createItemOptionsHtml() { /* ... same implementation ... */ }
    function addItemRow() { /* ... same implementation ... */ }
    function removeItemRow(button) { /* ... same implementation ... */ }
    document.getElementById('add-item-btn').addEventListener('click', addItemRow);
</script>