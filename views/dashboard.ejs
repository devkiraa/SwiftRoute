<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - <%= companyDetails.companyName %> - SwiftRoute</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Dropdown transition */
    .dropdown-menu {
      transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
      visibility: hidden;
      opacity: 0;
      z-index: 50; /* Ensure dropdown is above other elements */
    }
    .dropdown-menu.show {
        visibility: visible;
        opacity: 1;
    }
    /* Additional style to prevent text selection during rapid clicks */
    button, a {
        user-select: none;
    }
  </style>
</head>
<body class="bg-gray-50">

  <div class="flex min-h-screen">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
      <div class="px-6 py-4 border-b"> <%# Added border %>
        <a href="/dashboard" class="text-xl font-bold tracking-tight text-gray-800 hover:text-blue-600">
          SwiftRoute
        </a>
      </div>
      <nav class="flex-1 px-4 pt-4 space-y-1"> <%# Adjusted padding/spacing %>
        <a
          href="/dashboard"
          class="flex items-center space-x-3 px-3 py-2 rounded-md text-white bg-blue-600 font-medium" <%# Current page - make active %>
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd"></path></svg>
          <span>Home</span>
        </a>
         <a
           href="/warehouses" <%# Add link to warehouses list (needs route/view) %>
           class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
             <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v2h14V5a1 1 0 00-1-1H4zM3 9v7a1 1 0 001 1h12a1 1 0 001-1V9H3z"></path></svg>
             <span>Warehouses</span>
         </a>
         <a
           href="/stores" <%# Add link to stores list (needs route/view) %>
           class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
           <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.496 2.132a1 1 0 00-.992 0l-7 4A1 1 0 003 8v8a1 1 0 001 1h3v-4a1 1 0 011-1h2a1 1 0 011 1v4h3a1 1 0 001-1V8a1 1 0 00-.504-.868l-7-4zM16 18H4v-8.134l6-3.429 6 3.43V18z" clip-rule="evenodd"></path></svg>
           <span>Stores</span>
         </a>
         <a
           href="/stores/new" <%# Link to the Add Store page we created %>
           class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
           <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clip-rule="evenodd"></path></svg>
           <span>Add New Store</span>
         </a>
         <a
           href="/items" <%# Add link to items list (needs route/view) %>
           class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
             <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg> <%# Changed Icon %>
             <span>Inventory / Items</span>
         </a>
         <a
           href="/orders" <%# Add link to orders list (needs route/view) %>
           class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
           <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"></path><path fill-rule="evenodd" d="M2 1a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1H2zm12 1H2v12h12V2z" clip-rule="evenodd"></path></svg> <%# Changed Icon %>
           <span>Orders</span>
         </a>
         <a
           href="/users" <%# Link to user management %>
           class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
           <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M7 8a3 3 0 100-6 3 3 0 000 6zM14.5 9a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM1.25 15a6.75 6.75 0 0113.5 0h3.25a.75.75 0 010 1.5H.75a.75.75 0 010-1.5h.5zM20 16.75a.75.75 0 01-.75.75h-.75a5.25 5.25 0 00-10.5 0h-.75a.75.75 0 010-1.5h.25a6.75 6.75 0 0113.5 0h.25a.75.75 0 01.75.75z"></path></svg>
           <span>Users</span>
         </a>
         <a
          href="/reporting"
          class="flex items-center space-x-3 px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
         >
            <svg class="w-5 h-5 text-gray-400 group-hover:text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm3 1a1 1 0 000 2h2a1 1 0 100-2H8zm-1 4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 4a1 1 0 100 2h1a1 1 0 100-2H8z" clip-rule="evenodd"></path></svg> <%# Changed Icon %>
            <span>Reporting</span>
         </a>
      </nav>
      <div class="relative mt-auto px-4 py-3 border-t border-gray-200"> <%# Adjusted padding %>
        <% if (typeof loggedInUser !== 'undefined' && loggedInUser) { %>
          <button
            id="profileToggle"
            class="w-full flex items-center justify-start space-x-3 focus:outline-none rounded-md p-2 hover:bg-gray-100" <%# Added padding/hover %>
            onclick="toggleProfileDropdown()"
            aria-expanded="false"
            aria-controls="profileDropdown"
          >
            <img
              src="<%= loggedInUser.avatarUrl || 'https://static-00.iconduck.com/assets.00/profile-icon-2048x2048-yj5zf8da.png' %>"
              alt="User Avatar"
              class="w-9 h-9 rounded-full bg-gray-200 object-cover flex-shrink-0" <%# Adjusted size/styling %>
            />
            <div class="text-left overflow-hidden flex-1"> <%# Added flex-1 %>
              <p class="text-sm font-medium text-gray-800 truncate"><%= loggedInUser.username %></p>
              <p class="text-xs text-gray-500 truncate"><%= companyDetails.companyName %></p>
            </div>
            <svg id="profileArrow" class="w-4 h-4 ml-auto transform transition-transform duration-200 flex-shrink-0 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
          </button>
          <div id="profileDropdown" class="dropdown-menu absolute bottom-full left-0 mb-2 w-full bg-white border border-gray-200 rounded-md shadow-lg py-1"> <%# Adjusted position/width %>
             <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
             <a href="/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
            <hr class="my-1 border-gray-200">
             <form action="/logout" method="POST" class="w-full"> <%# Use form for POST logout %>
                <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
             </form>
           </div>
        <% } else { %>
           <p class="text-sm text-gray-500">Not logged in.</p>
           <a href="/login" class="text-sm text-blue-600 hover:underline">Login</a>
        <% } %>
      </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden"> <%# Added overflow hidden %>
      <header class="py-3 px-6 border-b border-gray-200 bg-white shadow-sm flex-shrink-0"> <%# Adjusted padding, added shadow %>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-800">Company Users</h2>
          <div class="flex space-x-2">
             <button class="px-3 py-1.5 border border-gray-300 text-xs font-medium text-gray-700 rounded-md hover:bg-gray-50"> <%# Adjusted size %>
               Import
             </button>
             <a href="/users/new" class="inline-block px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700"> <%# Adjusted size %>
               Add User
             </a>
           </div>
        </div>
      </header>

      <section class="p-6 bg-gray-50 flex-shrink-0"> <%# Made section shrinkable %>
        <% if (typeof stats !== 'undefined') { %>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white border rounded-lg p-4 shadow-sm"> <%# Added shadow %>
              <p class="text-sm font-medium text-gray-500">Total Stores</p>
              <div class="mt-1">
                <h3 class="text-2xl font-semibold text-gray-900"><%= stats.totalStores %></h3>
              </div>
            </div>
            <div class="bg-white border rounded-lg p-4 shadow-sm">
              <p class="text-sm font-medium text-gray-500">Total Warehouses</p>
              <div class="mt-1">
                <h3 class="text-2xl font-semibold text-gray-900"><%= stats.totalWarehouses %></h3>
              </div>
            </div>
            <div class="bg-white border rounded-lg p-4 shadow-sm">
              <p class="text-sm font-medium text-gray-500">Total Inventory Count</p>
              <div class="mt-1">
                <h3 class="text-2xl font-semibold text-gray-900"><%= stats.totalItemCount %></h3>
              </div>
            </div>
            <div class="bg-white border rounded-lg p-4 shadow-sm">
              <p class="text-sm font-medium text-gray-500">Pending Orders</p>
              <div class="mt-1">
                <h3 class="text-2xl font-semibold text-gray-900"><%= stats.pendingOrdersCompanyWide %></h3>
              </div>
            </div>
          </div>
        <% } %>
      </section>

      <section class="px-6 pb-6 flex-1 overflow-y-auto"> <%# Changed to overflow-y-auto %>
        <div class="bg-white border rounded-lg shadow-sm">
           <div class="px-4 py-3 border-b">
             <h3 class="text-base font-semibold text-gray-700">Company Users</h3>
           </div>

          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-gray-50 border-b text-xs uppercase text-gray-500 tracking-wider">
                <tr>
                  <th class="px-4 py-2 font-medium">Name</th>
                  <th class="px-4 py-2 font-medium">Role</th>
                  <th class="px-4 py-2 font-medium">Assigned Store</th>
                  <th class="px-4 py-2 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y text-sm text-gray-700">
                <% if (typeof tableData !== 'undefined' && tableData.length > 0) { %>
                  <% tableData.forEach(user => { %>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap"> <%# Added nowrap %>
                      <div class="flex items-center space-x-3">
                        <img
                          src="<%= user.avatarUrl || 'https://static-00.iconduck.com/assets.00/profile-icon-2048x2048-yj5zf8da.png' %>"
                          alt="Avatar"
                          class="w-8 h-8 rounded-full bg-gray-200 object-cover flex-shrink-0" <%# Added object-cover %>
                        />
                        <div>
                          <p class="font-medium text-gray-900"><%= user.username %></p>
                          <p class="text-xs text-gray-500"><%= user.email %></p>
                        </div>
                      </div>
                    </td>
                    <td class="px-4 py-3">
                      <% // --- Calculate role class ---
                         let roleClass = 'bg-gray-100 text-gray-700'; // Default class
                         switch (user.role) {
                           case 'warehouse_owner':
                             roleClass = 'bg-indigo-100 text-indigo-700'; break;
                           case 'store_owner':
                             roleClass = 'bg-green-100 text-green-700'; break;
                           case 'employee':
                             roleClass = 'bg-yellow-100 text-yellow-700'; break;
                           case 'delivery_partner':
                             roleClass = 'bg-purple-100 text-purple-700'; break;
                           // Add other roles if needed
                         }
                      %>
                      <% // --- Output the span with the calculated class --- %>
                      <span class="inline-block px-2 py-1 text-xs font-medium rounded-full <%= roleClass %>">
                           <%= user.role.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                      </span>
                   </td>
                     <td class="px-4 py-3 whitespace-nowrap"> <%# Added nowrap %>
                        <a href="/users/<%= user._id %>/edit" class="text-blue-600 hover:text-blue-800 hover:underline text-xs font-medium">Edit</a>
                        </td>
                  </tr>
                  <% }) %>
                <% } else { %>
                    <tr><td colspan="4" class="text-center py-10 text-gray-500">No users found for this company.</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
            <div class="flex items-center justify-between p-3 border-t bg-gray-50 rounded-b-lg"> <%# Adjusted padding/bg %>
              <p class="text-xs text-gray-600">Page <%= pagination.currentPage %> of <%= pagination.totalPages %></p>
              <div class="space-x-1">
                <a href="?page=<%= pagination.currentPage - 1 %>" class="inline-block px-3 py-1 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-100 <%= pagination.currentPage === 1 ? 'opacity-50 cursor-not-allowed' : '' %>">
                  Previous
                </a>
                <a href="?page=<%= pagination.currentPage + 1 %>" class="inline-block px-3 py-1 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-100 <%= pagination.currentPage === pagination.totalPages ? 'opacity-50 cursor-not-allowed' : '' %>">
                  Next
                </a>
              </div>
            </div>
          <% } %>
        </div>
      </section>
    </div> </div> <script>
    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      const arrow = document.getElementById('profileArrow');
      // Use 'show' class for better transitions if defined in CSS
      dropdown.classList.toggle('hidden');
      dropdown.classList.toggle('show'); // Add this if using opacity/visibility transitions
      arrow.classList.toggle('rotate-180');
      // Set aria-expanded state
      const isExpanded = !dropdown.classList.contains('hidden');
       document.getElementById('profileToggle').setAttribute('aria-expanded', isExpanded);
    }

    // Close dropdown on outside click
    document.addEventListener('click', function(event) {
      const profileButton = document.getElementById('profileToggle');
      const dropdown = document.getElementById('profileDropdown');

      // Check if elements exist before trying to access properties/methods
      if (profileButton && dropdown && !profileButton.contains(event.target) && !dropdown.contains(event.target)) {
        if (!dropdown.classList.contains('hidden')) { // Only act if it's visible
            dropdown.classList.add('hidden');
            dropdown.classList.remove('show');
            document.getElementById('profileArrow')?.classList.remove('rotate-180');
            profileButton.setAttribute('aria-expanded', 'false');
        }
      }
    });
  </script>
</body>
</html>