<%# Use pageTitle passed from route %>
<% locals.pageTitle = typeof title !== 'undefined' ? title : 'Dashboard' %>

<header class="py-3 px-6 border-b border-gray-200 bg-white shadow-sm flex-shrink-0">
    <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800"><%= locals.pageTitle %></h2>
         <%# Conditionally show Create Order Button %>
         <% if (typeof canCreateOrder !== 'undefined' && canCreateOrder) { %>
             <a href="/orders/new" class="inline-block px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700">
                 Create Manual Order
             </a>
         <% } %>
     </div>
</header>

<section class="p-6 bg-gray-50 flex-shrink-0">
    <% if (typeof stats !== 'undefined' && stats && Object.keys(stats).length > 0) { %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <% Object.entries(stats).forEach(([key, value]) => { %>
            <div class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200">
                <p class="text-sm font-medium text-gray-500 truncate"><%= key %></p> <%# Key is already formatted %>
                <div class="mt-1">
                    <h3 class="text-2xl font-semibold text-gray-900"><%= value %></h3>
                </div>
                 <%# Optional: Add links based on key %>
                 <% if (key.includes('Orders')) { %>
                    <a href="/orders" class="text-xs text-blue-600 hover:underline mt-2 inline-block">View Orders</a>
                 <% } else if (key === 'Stores') { %>
                     <a href="/stores" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Manage Stores</a>
                 <% } else if (key === 'Warehouses') { %>
                     <a href="/warehouses" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Manage Warehouses</a>
                 <% } else if (key === 'Inventory Items') { %>
                     <a href="/items" class="text-xs text-blue-600 hover:underline mt-2 inline-block">View Inventory</a>
                 <% } else if (key === 'Delivery Partners' || key === 'Users') { %>
                      <a href="/users" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Manage Users</a>
                 <% } else if (key.includes('Deliveries')) { %>
                       <a href="/deliveries/my" class="text-xs text-blue-600 hover:underline mt-2 inline-block">View Deliveries</a>
                 <% } %>
            </div>
        <% }) %>
    </div>
    <% } else { %>
         <div class="bg-white border rounded-lg shadow-sm p-6 text-center">
            <p class="text-sm text-gray-500">No specific dashboard statistics available for your role yet.</p>
        </div>
    <% } %>
</section>

<section class="px-6 pb-6 flex-1 overflow-y-auto space-y-6"> <%# Added space-y %>

    <div class="bg-white border rounded-lg shadow-sm p-6">
       <h3 class="text-base font-semibold text-gray-700 mb-4">Welcome, <%= locals.loggedInUser ? loggedInUser.username : 'User' %>!</h3>
       <p class="text-sm text-gray-600">
           <% if (locals.loggedInUser) { %>
                <% if (loggedInUser.role === 'warehouse_owner') { %>
                    Manage warehouses, stores, inventory, users, and view company-wide orders from the sidebar.
                <% } else if (loggedInUser.role === 'admin') { %>
                     Manage companies, users, and view platform-wide data from the sidebar.
                <% } else if (loggedInUser.role === 'store_owner') { %>
                    Manage orders, customers, inventory, and employees for <%= locals.storeDetails ? `store: ${locals.storeDetails.storeName}` : 'your assigned store' %> using the sidebar links.
                <% } else if (loggedInUser.role === 'employee') { %>
                    Manage orders, customers, and inventory for <%= locals.storeDetails ? `store: ${locals.storeDetails.storeName}` : 'your assigned store' %> using the sidebar links.
                 <% } else if (loggedInUser.role === 'delivery_partner') { %>
                    View your assigned deliveries and route map using the sidebar links. Update delivery statuses as you complete them.
                 <% } else { %>
                     Select an option from the sidebar to get started.
                 <% } %>
            <% } %>
       </p>
    </div>

    <% if (typeof recentOrders !== 'undefined' && recentOrders.length > 0) { %>
     <div class="bg-white border rounded-lg shadow-sm">
         <div class="px-4 py-3 border-b">
             <h3 class="text-base font-semibold text-gray-700">
                 <% if (locals.loggedInUser?.role === 'delivery_partner') { %>Current Deliveries<% } else { %>Recent Orders<% } %>
             </h3>
         </div>
         <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b text-xs uppercase text-gray-500 tracking-wider">
                    <tr>
                        <th class="px-4 py-2 font-medium">Order ID</th>
                        <th class="px-4 py-2 font-medium">Date</th>
                        <th class="px-4 py-2 font-medium">Store</th>
                        <% if (locals.loggedInUser?.role !== 'delivery_partner') { %><th class="px-4 py-2 font-medium">Customer</th><% } %>
                        <th class="px-4 py-2 font-medium text-right">Amount</th>
                        <th class="px-4 py-2 font-medium">Status</th>
                        <th class="px-4 py-2 font-medium"></th> <%# Actions %>
                    </tr>
                </thead>
                <tbody class="divide-y text-sm text-gray-700">
                     <% recentOrders.forEach(order => { %>
                         <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-mono text-xs">...<%= order._id.toString().slice(-8) %></td>
                            <td class="px-4 py-3 whitespace-nowrap"><%= new Date(order.placedDate).toLocaleDateString() %></td>
                            <td class="px-4 py-3"><%= order.storeId?.storeName || 'N/A' %></td>
                            <% if (locals.loggedInUser?.role !== 'delivery_partner') { %><td class="px-4 py-3"><%= order.customerName || order.customerId?.username || 'N/A' %></td><% } %>
                            <td class="px-4 py-3 text-right">$<%= order.totalAmount.toFixed(2) %></td>
                            <td class="px-4 py-3"><span class="inline-block px-2 py-1 text-xs font-medium rounded-full capitalize <% /* Status class logic */ %>"><%= order.orderStatus %></span></td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <a href="/orders/<%= order._id %>" class="text-blue-600 hover:underline text-xs font-medium">View</a>
                            </td>
                         </tr>
                     <% }) %>
                 </tbody>
             </table>
         </div>
     </div>
     <% } %>

</section>