<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title><%= typeof locals.pageTitle !== 'undefined' ? locals.pageTitle : 'SwiftRoute Dashboard' %></title> <%# Use locals.pageTitle %>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Dropdown styles */
        .dropdown-menu {
            transition: opacity 0.1s ease-out, transform 0.1s ease-out; /* Faster transition */
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px); /* Start slightly lower */
            z-index: 50; /* Ensure it's above other content */
        }
        .dropdown-menu.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0); /* Move to final position */
        }
        button, a { user-select: none; }
        /* Active link style */
        .sidebar-link-active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            font-weight: 500; /* medium */
        }
        /* Remove SVG-specific active style */
        /* .sidebar-link-active svg { color: white; } */
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex min-h-screen">

        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
            <div class="px-6 py-4 border-b">
                <a href="/dashboard" class="text-xl font-bold tracking-tight text-gray-800 hover:text-blue-600">SwiftRoute</a>
            </div>
            <nav class="flex-1 px-4 pt-4 space-y-1 overflow-y-auto">
                <% if (locals.loggedInUser) { %>
                    <a href="/dashboard" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath === '/dashboard' ? 'sidebar-link-active' : 'text-gray-700' %>">
                         <span>Home</span>
                    </a>

                    <% if (loggedInUser.role === 'warehouse_owner') { %>
                         <a href="/warehouses" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/warehouses') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Warehouses</span> </a>
                         <a href="/stores" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/stores') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Stores</span> </a>
                         <%# Keep Add New Store link accessible, maybe move higher? %>
                         <%# <a href="/stores/new" class="flex items-center px-3 py-2 ..."> <span>Add New Store</span> </a> %>
                         <a href="/items" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/items') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Inventory</span> </a>
                         <a href="/orders" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/orders') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Orders (Company)</span> </a>
                         <a href="/users" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/users') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Users</span> </a>
                         <a href="/reporting" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/reporting') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Reporting</span> </a>
                    <% } %>

                     <% if (loggedInUser.role === 'store_owner') { %>
                         <a href="/orders" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/orders') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Orders (My Store)</span> </a>
                         <a href="/customers" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/customers') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Customers</span> </a>
                         <a href="/items/store" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/items/store') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Inventory</span> </a>
                         <a href="/users/store" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/users/store') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Employees</span> </a>
                         <a href="/reporting/store" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/reporting/store') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Reporting</span> </a>
                    <% } %>

                    <% if (loggedInUser.role === 'employee') { %>
                          <a href="/orders" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/orders') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Orders</span> </a>
                          <a href="/customers" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/customers') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Customers</span> </a>
                          <a href="/items/store" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/items/store') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Inventory</span> </a>
                    <% } %>

                     <% if (loggedInUser.role === 'delivery_partner') { %>
                          <a href="/deliveries/my" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/deliveries/my') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>My Deliveries</span> </a>
                          <a href="/deliveries/map" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/deliveries/map') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Route Map</span> </a>
                    <% } %>

                    <% if (loggedInUser.role === 'admin') { %>
                          <a href="/admin/companies" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/admin/companies') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Companies</span> </a>
                          <a href="/admin/users" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/admin/users') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>All Users</span> </a>
                           <%# Add other admin links: All Warehouses, Stores, Orders? %>
                          <a href="/admin/settings" class="flex items-center px-3 py-2 rounded-md text-sm hover:bg-gray-100 hover:text-gray-900 <%= locals.currentPath.startsWith('/admin/settings') ? 'sidebar-link-active' : 'text-gray-700' %>"> <span>Platform Settings</span> </a>
                    <% } %>
                <% } %>
            </nav>

            <div class="relative mt-auto px-4 py-3 border-t border-gray-200">
                 <% if (locals.loggedInUser) { %>
                     <button id="profileToggle" class="w-full flex items-center text-left space-x-3 focus:outline-none rounded-md p-2 hover:bg-gray-100" aria-expanded="false" aria-controls="profileDropdown">
                         <div class="flex-1 overflow-hidden">
                             <p class="text-sm font-medium text-gray-800 truncate"><%= loggedInUser.username %></p>
                             <p class="text-xs text-gray-500 truncate capitalize">
                                 <%# Adjust fallback logic if needed %>
                                 <%= locals.companyDetails ? locals.companyDetails.companyName : (loggedInUser.role ? loggedInUser.role.replace(/_/g, ' ') : 'N/A') %>
                             </p>
                         </div>
                         <svg id="profileArrow" class="w-4 h-4 ml-auto transform transition-transform duration-200 flex-shrink-0 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                     </button>
                     <div id="profileDropdown" class="dropdown-menu absolute bottom-full left-0 mb-1 w-[calc(100%-2rem)] mx-4 bg-white border border-gray-200 rounded-md shadow-lg py-1">
                         <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                         <a href="/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                         <hr class="my-1 border-gray-200">
                         <form action="/logout" method="POST" class="w-full">
                             <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                         </form>
                     </div>
                 <% } else { %>
                     <a href="/login" class="text-sm text-blue-600 hover:underline">Login</a>
                 <% } %>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <%- body %> </div>

    </div>

    <script>
        const profileToggleButton = document.getElementById('profileToggle');
        const profileDropdownMenu = document.getElementById('profileDropdown');
        const profileArrow = document.getElementById('profileArrow');

        function toggleProfileDropdown() {
            const isExpanded = profileToggleButton.getAttribute('aria-expanded') === 'true';
            profileToggleButton.setAttribute('aria-expanded', !isExpanded);
            profileDropdownMenu.classList.toggle('show');
            if (profileArrow) {
                 profileArrow.classList.toggle('rotate-180'); // Rotate arrow
            }
        }

        if (profileToggleButton && profileDropdownMenu) {
             profileToggleButton.addEventListener('click', (event) => {
                 event.stopPropagation(); // Prevent click from immediately closing dropdown
                 toggleProfileDropdown();
             });

             // Close dropdown if clicking outside
             document.addEventListener('click', (event) => {
                 if (!profileDropdownMenu.contains(event.target) && !profileToggleButton.contains(event.target)) {
                     if (profileDropdownMenu.classList.contains('show')) {
                         toggleProfileDropdown(); // Close it
                     }
                 }
             });
        }
     </script>
</body>
</html>